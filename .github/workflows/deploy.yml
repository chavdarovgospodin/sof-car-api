name: Deploy via FTP to sof-car.eu/api
on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_TOKEN }}

      - name: Create .env file
        run: |
          echo "Creating .env file..."
          cat > .env << EOF
          SUPABASE_URL=${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY=${{ secrets.SUPABASE_ANON_KEY }}
          SUPABASE_SERVICE_ROLE_KEY=${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          SECRET_KEY=${{ secrets.SECRET_KEY }}
          ADMIN_USERNAME=${{ secrets.ADMIN_USERNAME }}
          ADMIN_PASSWORD=${{ secrets.ADMIN_PASSWORD }}
          EMAILJS_SERVICE_ID=${{ secrets.EMAILJS_SERVICE_ID }}
          EMAILJS_PUBLIC_KEY=${{ secrets.EMAILJS_PUBLIC_KEY }}
          EMAILJS_PRIVATE_KEY=${{ secrets.EMAILJS_PRIVATE_KEY }}
          EMAILJS_CONTACT_TEMPLATE_ID=${{ secrets.EMAILJS_CONTACT_TEMPLATE_ID }}
          EMAILJS_BOOKING_TEMPLATE_ID=${{ secrets.EMAILJS_BOOKING_TEMPLATE_ID }}
          FLASK_ENV=production
          RATE_LIMIT_MAX_REQUESTS=5
          RATE_LIMIT_WINDOW_HOURS=1
          LOG_LEVEL=INFO
          EOF
          echo "Contents of .env file:"
          cat .env

      - name: Ensure tmp directory exists
        run: mkdir -p tmp

      - name: Trigger Passenger restart
        run: |
          echo "restart $(date)" > tmp/restart.txt

      - name: FTP Deploy
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: sof-car.eu
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: ./
          server-dir: /api/
          exclude: |
            **/.git*
            **/.git*/**
            **/.github/**
            **/README.md
            **/.gitignore
            **/.env.example
            **/test_api.py
          dangerous-clean-slate: false
